name: 🚀 Deploy to EC2 (Complete)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  REPO_URL: https://github.com/netakenilesh/godproject.git

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🛎️ Checkout code
      uses: actions/checkout@v3

    - name: 🔐 Setup SSH
      run: |
        set -x
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/ec2_key.pem
        chmod 600 ~/.ssh/ec2_key.pem
        ssh-keyscan -v -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: 📤 Prepare and transfer files
      run: |
        set -x
        mkdir -p /tmp/deployment
        cp -r backend frontend docker-compose.prod.yml .env.production nginx.conf /tmp/deployment/ || true
        
        tar -czf /tmp/deployment.tar.gz -C /tmp/deployment .
        
        scp -v -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key.pem /tmp/deployment.tar.gz ubuntu@${{ secrets.EC2_HOST }}:/tmp/

    - name: 🚀 Setup and deploy on EC2
      run: |
        set -x
        ssh -v -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key.pem ubuntu@${{ secrets.EC2_HOST }} "
          set -e
          echo '🎯 Connected to EC2 ✅'
          hostname
          whoami
          
          # Ensure Docker is installed
          if ! command -v docker &> /dev/null; then
            echo '🐳 Installing Docker...'
            sudo apt-get update -y
            sudo apt-get install -y ca-certificates curl gnupg lsb-release
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg
