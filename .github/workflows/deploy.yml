name: ğŸš€ Deploy to EC2

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ—ï¸ Build React App
        run: |
          cd frontend
          npm install
          npm run build
          echo "âœ… React app built"
          ls -la dist/

      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Prepare and transfer files
        run: |
          # Create a clean copy without live operations
          mkdir -p /tmp/deployment
          echo "ğŸ“‚ Copying files to temporary directory..."
          cp -r backend frontend docker-compose.prod.yml nginx.conf /tmp/deployment/
          
          # Copy .env.production if it exists, otherwise skip
          cp .env.production /tmp/deployment/ 2>/dev/null || echo "â„¹ï¸ .env.production not found, will need to create manually"
          
          echo "ğŸ“¦ Creating archive from clean copy..."
          cd /tmp/deployment
          tar -czf /tmp/deployment.tar.gz .
          
          echo "ğŸ“ Archive contents:"
          tar -tzf /tmp/deployment.tar.gz | head -20
          
          echo "ğŸš€ Transferring to EC2..."
          scp -i ~/.ssh/ec2_key.pem /tmp/deployment.tar.gz ubuntu@${{ secrets.EC2_HOST }}:/tmp/
          echo "âœ… Files transferred successfully"

      - name: ğŸš€ Deploy application
        run: |
          ssh -i ~/.ssh/ec2_key.pem ubuntu@${{ secrets.EC2_HOST }} "
            set -e
            echo 'ğŸš€ Starting deployment...'
            
            # Create app directory
            sudo mkdir -p /opt/app
            sudo chown ubuntu:ubuntu /opt/app
            cd /opt/app
            
            # Extract files
            echo 'ğŸ“¦ Extracting deployment files...'
            tar -xzf /tmp/deployment.tar.gz
            ls -la
            
            # Verify critical files exist
            echo 'ğŸ” Verifying files...'
            if [ ! -f .env.production ]; then
              echo 'âŒ .env.production missing - please create it manually'
              echo 'You can create it with: sudo nano /opt/app/.env.production'
              exit 1
            fi
            
            echo 'ğŸ“ Frontend dist contents:'
            ls -la frontend/dist/ || echo 'âš ï¸ frontend/dist not found, will build on EC2'
            
            # Build React app on EC2 if needed
            if [ ! -d 'frontend/dist' ] || [ -z \"\$(ls -A frontend/dist)\" ]; then
              echo 'ğŸ—ï¸ Building React app on EC2...'
              cd frontend
              npm install
              npm run build
              cd ..
              echo 'âœ… React app built on EC2'
            fi
            
            echo 'ğŸ³ Starting Docker services...'
            sudo docker-compose -f docker-compose.prod.yml down || true
            sudo docker-compose -f docker-compose.prod.yml up --build -d
            
            echo 'â³ Waiting for services to start...'
            sleep 30
            
            echo 'ğŸ—ƒï¸ Running database migrations...'
            sudo docker-compose -f docker-compose.prod.yml exec backend npx prisma db push
            
            echo 'âœ… Deployment successful!'
          "

      - name: ğŸ§ª Verify deployment
        run: |
          ssh -i ~/.ssh/ec2_key.pem ubuntu@${{ secrets.EC2_HOST }} "
            echo 'ğŸ§ª Running verification checks...'
            echo 'ğŸ“‹ Container status:'
            sudo docker-compose ps
            echo 'ğŸ”§ Testing backend...'
            curl -f http://localhost:4000/api/health && echo 'âœ… Backend is healthy'
            echo 'ğŸŒ Testing frontend...'
            curl -f http://localhost:8080/ && echo 'âœ… Frontend is serving'
          "