name: 🚀 Deploy to EC2 (Complete)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  REPO_URL: https://github.com/netakenilesh/godproject.git

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🛎️ Checkout code
      uses: actions/checkout@v3

    - name: 🔐 Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/ec2_key.pem
        chmod 600 ~/.ssh/ec2_key.pem
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: 📤 Prepare and transfer files
      run: |
        # Create a clean copy without unnecessary files
        mkdir -p /tmp/deployment
        cp -r backend frontend docker-compose.prod.yml .env.production nginx.conf /tmp/deployment/
        
        # Create tar archive
        tar -czf /tmp/deployment.tar.gz -C /tmp/deployment .

        # Transfer to EC2
        scp -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key.pem /tmp/deployment.tar.gz ubuntu@${{ secrets.EC2_HOST }}:/tmp/

    - name: 🚀 Setup and deploy on EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key.pem ubuntu@$_
